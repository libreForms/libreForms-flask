{% extends 'base.html' %}
{% block content %}
 
<form method="post">
  <fieldset>
    <div class="form-group">
      <label class="form-label mt-4 required" for="name" data-bs-toggle="tooltip" data-bs-placement="right" title="Enter a name for the new report (100 chars max)">Name</label>
      <input class="form-control" type="text" id="name" name="name" value="{{ report.name if report else ''}}" maxlength="100" required/>
    </div>
    
    <!-- <div class="form-group">
      <label class="form-label mt-4 required" for="form_name" data-bs-toggle="tooltip" data-bs-placement="right" title="Select the form for which you'd like to generate a report">Frequency</label>
      <select id="form_name" name="form_name">
        {% for form in forms %}
        <option value="{{ form }}">{ form }}</option>
        {% endfor %}
      </select>
    </div> -->

    <div class="form-group">
      <label class="form-label mt-4 required" for="filters" data-bs-toggle="tooltip" data-bs-placement="right" title="Enter any filters you want to apply (300 chars max)">Filters</label><span data-bs-toggle="tooltip" data-bs-placement="right" title="Click me for help"><button class="btn btn-link btn-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterHelp" aria-controls="filterHelp">(?)</button></span>
      <textarea class="form-control" rows="3" id="filters" name="filters" maxlength="300" onchange = "validateFilter(this.form.filters.value);" required>{{ report.filters if report else ''}}</textarea>
      <div class="valid-feedback">These filters are valid!</div>
      <div class="invalid-feedback">These filters are invalid! Click the (?) above for more information.</div>    
    </div>

    <div class="form-group">
      <label class="form-label mt-4 required" for="frequency" data-bs-toggle="tooltip" data-bs-placement="right" title="Select the frequency you'd like to receive the report at">Frequency</label>
      <select class="form-control" id="frequency" name="frequency" required>
        <option value="hourly"{%if report and report.frequency == 'hourly'%} selected="selected"{%endif%}>Hourly</option>
        <option value="daily"{%if report and report.frequency == 'daily'%} selected="selected"{%endif%}>Daily</option>
        <option value="weekly"{%if report and report.frequency == 'weekly'%} selected="selected"{%endif%}>Weekly</option>
        <option value="monthly"{%if report and report.frequency == 'monthly'%} selected="selected"{%endif%}>Monthly</option>
        <option value="annually"{%if report and report.frequency == 'annually'%} selected="selected"{%endif%}>Annually</option>
        <option value="manual"{%if report and report.frequency == 'manual'%} selected="selected"{%endif%}>Manual</option>
      </select>
    </div>


    <div class="form-group">
      <label class="form-label mt-4 required" for="type" data-bs-toggle="tooltip" data-bs-placement="right" title="Select the timeframe for the reports you'd like captured by this report">Forms Included</label>
      <select class="form-control" id="type" name="type" required>
        <option value="created_since_last_run"{%if report and report.type == 'created_since_last_run'%} selected="selected"{%endif%}>Forms created since last run</option>
        <option value="modified_since_last_run"{%if report and report.type == 'modified_since_last_run'%} selected="selected"{%endif%}>Forms modified since last run</option>
        <option value="created_all_time"{%if report and report.type == 'created_all_time'%} selected="selected"{%endif%}>Forms created all time</option>
        <option value="static_last_hour"{%if report and report.type == 'static_last_hour'%} selected="selected"{%endif%}>Forms created in the last hour</option>
        <option value="static_last_day"{%if report and report.type == 'static_last_day'%} selected="selected"{%endif%}>Forms created in the last day</option>
        <option value="static_last_month"{%if report and report.type == 'static_last_month'%} selected="selected"{%endif%}>Forms created in the last month</option>
        <option value="static_last_year"{%if report and report.type == 'static_last_year'%} selected="selected"{%endif%}>Forms created in the last year</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label mt-4" for="start_at" data-bs-toggle="tooltip" data-bs-placement="right" title="Select the starting date (defaults to today)">Start Date</label>
      <input class="form-control" type="date" id="start_at" name="start_at" value="{{ report.start_at_human_readable if report else ''}}"/>
    </div>

    <div class="form-group">
      <label class="form-label mt-4" for="end_at" data-bs-toggle="tooltip" data-bs-placement="right" title="Select the ending date (defaults to never)">End Date</label>
      <input class="form-control" type="date" id="end_at" name="end_at" value="{{ report.end_at_human_readable if report else ''}}"/> 
    </div>

    <div class="form-group mt-4">
      <input type="submit" value="Submit" class="btn btn-primary" />    
    </div>
  </fieldset>
</form> 

{% if msg %}

  {{ msg }}

{% endif %}    

{% endblock %}


{% block addons %}

<div class="offcanvas offcanvas-bottom"  style="z-index:999998 !important;" tabindex="-1" id="filterHelp" aria-labelledby="filterHelpLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filterHelpLabel">Using Report Filters</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div>
      <p>Report filters are used to filter results that will be captured by each report, using comma-separated conditions. All conditions described here must be met in order for the report to be sent. 
        Please include a space between conditions and operators. The left field should contain the name of a form field, while the right field should contain some value that the system can match. These 
        conditions should employ standard Python operators, see <a href="https://www.w3schools.com/python/python_operators.asp">https://www.w3schools.com/python/python_operators.asp</a>.</p>
      <h6>Examples</h6>
      <ul>
        <li><code>Team_Name == Budget,</code></li>
        <li><code>Team_Name != Marketing,</code></li>
        <li><code>Proposed_Cost > 1000000,</code></li>
        <li><code>Owner == john.smith,</code></li>
      </ul>
    </div>
  </div>
</div>


{% endblock %}

{% block js %}


async function validateFilter(s) {

  const foo = document.getElementById("filters")

  let payload = {
    string: s
  };

  let response = await fetch('{{ url_for ('reports.view_lint_filters') }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json;charset=utf-8'
    },
    body: JSON.stringify(payload)
  });
  
  let result = await response.json();

  if (result['status'] == 'success') {
    foo.classList.remove("is-invalid")
    foo.classList.add("is-valid")
  } else {
    foo.classList.add("is-invalid")
    foo.classList.remove("is-valid")
  }
}

{% endblock %}